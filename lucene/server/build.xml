<project name="luceneserver" default="jar" basedir="."
         xmlns:ivy="antlib:org.apache.ivy.ant"
         xmlns:junit4="antlib:com.carrotsearch.junit4">

  <path id="compile.path">
    <path refid="dependencies.path"/>
  </path>

  <path id="test.path">
    <pathelement location="build/classes/java"/>
    <path refid="compile.path"/>
  </path>

  <target name="resolve">
    <!-- override: just for safety, should be unnecessary -->
    <ivy:configure file="ivy-settings.xml" override="true"/>
    <ivy:cachepath pathid="dependencies.path" log="download-only" type="bundle,jar"/>
    <taskdef resource="com/carrotsearch/junit4/antlib.xml" uri="antlib:com.carrotsearch.junit4" classpathref="dependencies.path"/>
  </target>

  <target name="clean">
    <delete dir="build"/>
  </target>

  <target name="compile" depends="resolve">
    <compile src="src/java" dest="build/classes/java" classpathref="compile.path"/>
  </target>

  <target name="compile-test" depends="compile">
    <compile src="src/test" dest="build/classes/test" classpathref="test.path"/>
  </target>

  <target name="jar" depends="compile">
    <jar destfile="build/luceneserver.jar" basedir="build/classes/java"/>
  </target>

  <macrodef name="compile">
      <attribute name="src"/>
      <attribute name="dest"/>
      <attribute name="classpathref"/>
    <sequential>
      <mkdir dir="@{dest}"/>
      <javac srcdir="@{src}"
             destdir="@{dest}"
             classpathref="@{classpathref}"
             includeantruntime="false"
             source="1.6"
             target="1.6"
	     debug="on"
             encoding="UTF-8">
        <compilerarg line="-Xlint -Xlint:-serial"/>
      </javac>
    </sequential>
  </macrodef>

  <condition property="tests.class" value="*.${testcase}">
    <isset property="testcase"/>
  </condition>

  <condition property="tests.method" value="*.${testmethod}">
    <isset property="testmethod"/>
  </condition>

  <property name="tests.jvms" value="auto" />

  <target name="test" depends="compile-test">
    <sequential>
      <mkdir dir="build/test"/>
      <junit4:pickseed property="tests.seed"/>
      <junit4:junit4 dir="build/test"
                     tempdir="build/test"
                     parallelism="${tests.jvms}">
         <assertions>
           <enable/>
         </assertions>
         <classpath location="build/classes/test"/>
         <classpath refid="test.path"/>
         <fileset dir="build/classes/test">
           <include name="**/Test*.class"/>
           <exclude name="**/*$*" />
         </fileset>
         <listeners>
           <junit4:report-text showThrowable="true" showStackTraces="true" showOutput="always" showStatusOk="false"/>
         </listeners>
      </junit4:junit4>

      <!-- nocommit is this "right"? -->
      <subant target="test" inheritall="false" failonerror="true">
        <fileset dir="plugins/BinaryDocument" includes="build.xml" />
      </subant>

    </sequential>
  </target>
 
</project>
